#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = ["click>=8.0", "pydantic>=2.0"]
# ///
"""Memory management CLI - invalid states unrepresentable via Pydantic"""

from __future__ import annotations
import json
import click
from datetime import datetime
from enum import Enum
from pathlib import Path
from pydantic import BaseModel, Field
from typing import Literal, Optional


# === TYPES: Pydantic makes invalid states unrepresentable ===


class EntityType(str, Enum):
    PROJECT = "project"
    DOMAIN = "domain"
    PATTERN = "pattern"
    FLOW = "flow"
    RISK = "risk"


class EntityMeta(BaseModel):
    """Entity metadata - Pydantic validates all constraints"""

    type: Literal["meta"] = "meta"
    id: str
    entity_type: EntityType
    created: datetime
    confidence: float = Field(ge=0.0, le=1.0)  # MUST be 0.0-1.0
    last_used: datetime
    use_count: int = Field(ge=1)  # MUST be >= 1


class Observation(BaseModel):
    """Observation - Pydantic ensures content exists and is non-empty"""

    type: Literal["observation"] = "observation"
    content: str = Field(min_length=1)  # Can't be empty
    added: datetime
    evidence: Optional[str] = None


class Relation(BaseModel):
    from_entity: str = Field(alias="from")
    to_entity: str = Field(alias="to")
    relation_type: str = Field(alias="type")
    created: datetime


# === CONSTANTS & HELPERS ===


def get_memory_dir(global_scope: bool = False) -> Path:
    """Get memory directory based on scope."""
    if global_scope:
        return Path.home() / ".claude" / "memory"
    return Path(".claude/memory")


def entity_file(entity_type: EntityType, name: str, global_scope: bool = False) -> Path:
    """Get entity file path based on scope."""
    return get_memory_dir(global_scope) / entity_type.value / f"{name}.jsonl"


# === COMMANDS ===


@click.group()
def cli():
    """Memory management for persistent project knowledge"""
    pass


@cli.command()
@click.argument("entity_type", type=click.Choice([t.value for t in EntityType]))
@click.argument("name")
@click.argument("observation")
@click.option("--evidence", help="Evidence file/commit reference")
@click.option("--confidence", type=float, default=0.7, help="Confidence 0.0-1.0")
@click.option(
    "--global",
    "global_scope",
    is_flag=True,
    help="Store in global memory (~/.claude/memory)",
)
def create(
    entity_type: str,
    name: str,
    observation: str,
    evidence: Optional[str],
    confidence: float,
    global_scope: bool,
):
    """Create new entity with first observation"""
    etype = EntityType(entity_type)
    file_path = entity_file(etype, name, global_scope)

    if file_path.exists():
        click.echo(f"Error: {etype.value}:{name} already exists", err=True)
        raise SystemExit(1)

    file_path.parent.mkdir(parents=True, exist_ok=True)
    now = datetime.now()

    # Pydantic validates - will raise if invalid
    meta = EntityMeta(
        id=f"{etype.value}:{name}",
        entity_type=etype,
        created=now,
        confidence=confidence,
        last_used=now,
        use_count=1,
    )

    obs = Observation(content=observation, added=now, evidence=evidence)

    with file_path.open("w") as f:
        f.write(meta.model_dump_json() + "\n")
        f.write(obs.model_dump_json(by_alias=True) + "\n")

    click.echo(f"✓ Created {meta.id}")


@cli.command()
@click.argument("entity_type", type=click.Choice([t.value for t in EntityType]))
@click.argument("name")
@click.argument("observation")
@click.option("--evidence", help="Evidence file/commit reference")
@click.option(
    "--global",
    "global_scope",
    is_flag=True,
    help="Use global memory (~/.claude/memory)",
)
def add(
    entity_type: str,
    name: str,
    observation: str,
    evidence: Optional[str],
    global_scope: bool,
):
    """Add observation to existing entity"""
    etype = EntityType(entity_type)
    file_path = entity_file(etype, name, global_scope)

    if not file_path.exists():
        click.echo(f"Error: {etype.value}:{name} not found", err=True)
        click.echo(f"Hint: Use 'memory create {etype.value} {name} \"...\"'", err=True)
        raise SystemExit(1)

    obs = Observation(content=observation, added=datetime.now(), evidence=evidence)

    # Update meta (increment use_count, update last_used)
    lines = file_path.read_text().splitlines()
    meta = EntityMeta.model_validate_json(lines[0])
    meta = meta.model_copy(
        update={"use_count": meta.use_count + 1, "last_used": datetime.now()}
    )

    with file_path.open("w") as f:
        f.write(meta.model_dump_json() + "\n")
        f.writelines(line + "\n" for line in lines[1:])
        f.write(obs.model_dump_json(by_alias=True) + "\n")

    click.echo(f"✓ Added observation to {etype.value}:{name}")


@cli.command()
@click.argument("search_term")
@click.option(
    "--global", "global_scope", is_flag=True, help="Search only global memory"
)
@click.option(
    "--project", "project_scope", is_flag=True, help="Search only project memory"
)
def query(search_term: str, global_scope: bool, project_scope: bool):
    """Search all entities (searches both scopes by default)"""
    # Determine which scopes to search
    if not global_scope and not project_scope:
        # Search both by default
        scopes = [get_memory_dir(False), get_memory_dir(True)]
    elif global_scope:
        scopes = [get_memory_dir(True)]
    else:
        scopes = [get_memory_dir(False)]

    results = []
    for memory_dir in scopes:
        if not memory_dir.exists():
            continue

        for jsonl_file in memory_dir.rglob("*.jsonl"):
            content = jsonl_file.read_text()
            if search_term.lower() in content.lower():
                lines = content.splitlines()
                if lines:
                    meta = json.loads(lines[0])
                    scope_label = (
                        "global" if memory_dir == get_memory_dir(True) else "project"
                    )
                    results.append((meta["id"], scope_label))

    if not results:
        click.echo(f"No entities found matching '{search_term}'")
        return

    click.echo(f"Found {len(results)} entities:\n")
    for entity_id, scope in results:
        click.echo(f"  [{scope}] {entity_id}")


@cli.command()
@click.argument("entity_type", type=click.Choice([t.value for t in EntityType]))
@click.argument("name")
@click.option(
    "--global",
    "global_scope",
    is_flag=True,
    help="Use global memory (~/.claude/memory)",
)
def show(entity_type: str, name: str, global_scope: bool):
    """Show full entity details"""
    etype = EntityType(entity_type)
    file_path = entity_file(etype, name, global_scope)

    if not file_path.exists():
        click.echo(f"Error: {etype.value}:{name} not found", err=True)
        raise SystemExit(1)

    lines = file_path.read_text().splitlines()
    meta = EntityMeta.model_validate_json(lines[0])

    click.echo(f"\n# {meta.id}")
    click.echo(f"Created: {meta.created}")
    click.echo(f"Confidence: {meta.confidence}")
    click.echo(f"Last used: {meta.last_used}")
    click.echo(f"Use count: {meta.use_count}\n")
    click.echo("## Observations\n")

    for line in lines[1:]:
        obs = Observation.model_validate_json(line)
        click.echo(f"- {obs.content}")
        if obs.evidence:
            click.echo(f"  Evidence: {obs.evidence}")
    click.echo()


@cli.command(name="list")
@click.argument(
    "entity_type", type=click.Choice([t.value for t in EntityType]), required=False
)
@click.option("--global", "global_scope", is_flag=True, help="List only global memory")
@click.option(
    "--project", "project_scope", is_flag=True, help="List only project memory"
)
def list_cmd(entity_type: Optional[str], global_scope: bool, project_scope: bool):
    """List all entities (lists both scopes by default)"""
    # Determine which scopes to list
    if not global_scope and not project_scope:
        scopes = [(get_memory_dir(False), "project"), (get_memory_dir(True), "global")]
    elif global_scope:
        scopes = [(get_memory_dir(True), "global")]
    else:
        scopes = [(get_memory_dir(False), "project")]

    for memory_dir, scope_label in scopes:
        if not memory_dir.exists():
            continue

        if entity_type:
            dirs = [memory_dir / entity_type]
        else:
            dirs = [d for d in memory_dir.iterdir() if d.is_dir()]

        for dir_path in sorted(dirs):
            if not dir_path.is_dir():
                continue

            files = [*dir_path.glob("*.jsonl")]
            if not files:
                continue

            click.echo(f"\n[{scope_label}] {dir_path.name}/")
            for file_path in sorted(files):
                lines = file_path.read_text().splitlines()
                if lines:
                    meta = EntityMeta.model_validate_json(lines[0])
                    click.echo(f"  {meta.id} (confidence: {meta.confidence})")


if __name__ == "__main__":
    cli()
